# סיכום בעיה: Redirects לא רצויים באזור האישי

## הבעיה

משתמשים מנויים (membership level 2 או 8) נתקלים בבעיות הבאות:

### 1. "הקורס שלי" מעביר לעמוד הבית
- **מה קורה:** לחיצה על "הקורס שלי" באזור האישי מעבירה לעמוד הבית במקום לעמוד "שיעורים"
- **מה אמור לקרות:** מעבר לעמוד "שיעורים" (`https://higayonbarie.co.il/%d7%a9%d7%99%d7%a2%d7%95%d7%a8%d7%99%d7%9d/`)
- **בקונסול:** הקישור ב-HTML נראה תקין: `href="https://higayonbarie.co.il/%d7%a9%d7%99%d7%a2%d7%95%d7%a8%d7%99%d7%9d/"`

### 2. "התשבצים שלי" נשאר ב-`/user/`
- **מה קורה:** לחיצה על "התשבצים שלי" באזור האישי נשארת ב-`/user/` במקום לעבור ל-`user_crosswords_page`
- **מה אמור לקרות:** מעבר לעמוד `user_crosswords_page` (`https://higayonbarie.co.il/user_crosswords_page/`)
- **בקונסול:** הקישור ב-HTML נראה תקין: `href="https://higayonbarie.co.il/user_crosswords_page/"`

### 3. "עריכת פרופיל" מעביר ל-`/user/`
- **מה קורה:** לחיצה על "עריכת פרופיל" באזור האישי מעבירה ל-`/user/` במקום ל-`/membership-account/your-profile/`
- **מה אמור לקרות:** מעבר ל-`/membership-account/your-profile/`
- **בקונסול:** הקישור ב-HTML נראה תקין: `href="https://higayonbarie.co.il/membership-account/your-profile/"`

## מה ניסיתי לעשות

### 1. הוספתי פילטר `pmpro_has_membership_access_filter`
**מיקום:** `themes/hello-theme-child/functions.php` (שורות 226-263)

```php
add_filter('pmpro_has_membership_access_filter', function($hasaccess, $post, $user, $levels) {
    if (!is_page()) {
        return $hasaccess;
    }
    
    if (!is_user_logged_in()) {
        return $hasaccess;
    }
    
    // Allow "התשבצים שלי" for all logged-in users
    $page_template = get_page_template_slug($post->ID);
    if ($page_template === 'template-user_crossword.php') {
        return true;
    }
    
    $page_slug = get_post_field('post_name', $post->ID);
    if (in_array($page_slug, ['user_crosswords_page', 'התשבצים-שלי'])) {
        return true;
    }
    
    // Allow "שיעורים" for logged-in users with membership
    if ($page_slug === 'שיעורים' || $page_slug === 'lessons') {
        if (function_exists('pmpro_hasMembershipLevel') && pmpro_hasMembershipLevel()) {
            return true;
        }
        return $hasaccess;
    }
    
    return $hasaccess;
}, 10, 4);
```

**תוצאה:** לא פתר את הבעיה - עדיין יש redirects.

### 2. הוספתי `template_redirect` עם priority 0
**מיקום:** `themes/hello-theme-child/functions.php` (שורות 142-180)

```php
add_action('template_redirect', function() {
    if (!is_page()) {
        return;
    }
    
    global $post;
    if (!$post) {
        return;
    }
    
    $page_template = get_page_template_slug($post->ID);
    $page_slug = get_post_field('post_name', $post->ID);
    
    // Check if this is "התשבצים שלי" page
    $is_user_crosswords = false;
    if ($page_template === 'template-user_crossword.php') {
        $is_user_crosswords = true;
    } elseif (in_array($page_slug, ['user_crosswords_page', 'התשבצים-שלי'])) {
        $is_user_crosswords = true;
    }
    
    // Check if this is "שיעורים" page
    $is_lessons = ($page_slug === 'שיעורים' || $page_slug === 'lessons');
    
    // Allow access for logged-in users
    if ($is_user_crosswords && is_user_logged_in()) {
        return; // Don't let PMPro redirect
    }
    
    if ($is_lessons && is_user_logged_in() && function_exists('pmpro_hasMembershipLevel') && pmpro_hasMembershipLevel()) {
        return; // Don't let PMPro redirect
    }
}, 0); // Priority 0 = runs BEFORE PMPro's template_redirect
```

**תוצאה:** לא פתר את הבעיה - עדיין יש redirects.

### 3. ניסיתי JavaScript force redirects
**מיקום:** `plugins/hb-cog-training/hb-cog-training.php`

**תוצאה:** המשתמש צדק - זה לא הפתרון הנכון. הסרתי את זה.

## מה לא עובד

1. **הקישורים ב-HTML נראים תקינים** - אבל יש redirect ב-PHP אחרי הלחיצה
2. **הפילטר `pmpro_has_membership_access_filter` לא עובד** - PMPro עדיין מבצע redirect
3. **ה-`template_redirect` עם priority 0 לא עובד** - PMPro עדיין מבצע redirect

## מה צריך לבדוק

### בממשק הניהול של וורדפרס:

1. **PMPro → Settings → Advanced Settings:**
   - מה ה-"Redirect Page" או "No Access Page"?
   - האם יש הגדרה שמעבירה לעמוד הבית או ל-`/user/` כשאין גישה?

2. **PMPro → Memberships → Levels:**
   - עבור כל רמת membership, בדוק אילו עמודים מוגבלים
   - האם עמוד "שיעורים" מוגבל לרמת membership מסוימת?
   - האם עמוד `user_crosswords_page` מוגבל?

3. **Pages → כל עמוד:**
   - עבור עמוד "שיעורים" - בדוק אם יש PMPro restriction
   - עבור עמוד `user_crosswords_page` - בדוק אם יש PMPro restriction

4. **PMPro → Settings → Pages:**
   - מה ה-"Account Page"?
   - האם יש הגדרה שמעבירה ל-`/user/`?

## שאלות לעצה

1. **למה `pmpro_has_membership_access_filter` לא עובד?** האם יש דרך אחרת למנוע את ה-redirect של PMPro?

2. **למה `template_redirect` עם priority 0 לא עובד?** האם PMPro רץ לפני זה או שיש דרך אחרת למנוע את ה-redirect?

3. **איפה PMPro מבצע את ה-redirect?** האם יש hook או filter אחר שאפשר להשתמש בו?

4. **האם יש הגדרות ב-PMPro בממשק הניהול שיכולות לגרום לזה?** מה צריך לבדוק שם?

5. **האם יש plugin אחר שיכול להפריע?** (WPUM, Elementor, וכו')

## קבצים רלוונטיים

- `themes/hello-theme-child/functions.php` - כל הקוד הרלוונטי
- `plugins/hb-cog-training/hb-cog-training.php` - קוד האזור האישי (שורות 2684-2907)
- `plugins/hb-homev2-shortcode/hb-homev2-shortcode.php` - קוד דף הבית

## מידע נוסף

- WordPress עם PMPro (Paid Memberships Pro)
- Theme: Hello Elementor Child
- Plugins נוספים: WPUM, Elementor, ACF
- הבעיה מתרחשת רק למשתמשים מנויים (membership level 2 או 8)
- הקישורים ב-HTML נראים תקינים - הבעיה היא ב-redirect ב-PHP
