<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#D4AF37">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="×™×•××Ÿ ×“× ×™×ª">
    <meta name="description" content="×™×•××Ÿ ×“×™×’×™×˜×œ×™ ××™×©×™ - ×¡×™×¤×•×¨ ×—×™×™× ××ª××©×š ×•××ª×¤×ª×—">
    <title>×™×•××Ÿ ×“× ×™×ª | Danit's Journal</title>
    
    <!-- Icons & Manifest -->
    <link rel="apple-touch-icon" href="/assets/icon.png?v=3">
    <link rel="manifest" href="/manifest_v2.json">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Rose Gold & Cream Luxury Theme */
            --pleasure-primary: #D4AF37;
            --pleasure-accent: #E8C547;
            --pleasure-peach: #FFB6B9;
            --pleasure-cream: #FFFEF7;
            --pleasure-bg-start: #FFFEF7;
            --pleasure-bg-end: #FFF9E6;
            --pleasure-text: #2C2C2C;
            --pleasure-text-light: #5A5A5A;
            --pleasure-border: rgba(212, 175, 55, 0.2);
            --pleasure-shadow: 0 4px 20px rgba(212, 175, 55, 0.15);
            --pleasure-shadow-hover: 0 12px 40px rgba(212, 175, 55, 0.25);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html {
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        body {
            font-family: 'Assistant', 'Heebo', 'Rubik', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            direction: rtl;
            text-align: right;
            background: linear-gradient(135deg, var(--pleasure-bg-start) 0%, var(--pleasure-bg-end) 100%);
            background-attachment: fixed;
            color: var(--pleasure-text);
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            padding-bottom: 100px;
        }
        
        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--pleasure-bg-start) 0%, var(--pleasure-bg-end) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        
        #splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .splash-icon {
            width: 120px;
            height: 120px;
            animation: fadeInScale 0.8s ease-out;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Header */
        .journal-header {
            background: rgba(255, 254, 247, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--pleasure-border);
            padding: 20px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.1);
            width: 100%;
            max-width: 100vw;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .journal-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--pleasure-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .journal-title-icon {
            width: 32px;
            height: 32px;
            color: var(--pleasure-primary);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-shrink: 0;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Search Input - Rose Gold Styled */
        .search-input-header {
            background: rgba(255, 254, 247, 0.95);
            border: 2px solid var(--pleasure-border);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            font-family: 'Assistant', sans-serif;
            color: var(--pleasure-text);
            width: 300px;
            transition: all 0.3s ease;
            direction: rtl;
        }
        
        .search-input-header:focus {
            outline: none;
            border-color: var(--pleasure-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .search-input-header::placeholder {
            color: var(--pleasure-text-light);
        }
        
        .header-button {
            background: transparent;
            border: 1px solid var(--pleasure-border);
            border-radius: 12px;
            padding: 8px 16px;
            color: var(--pleasure-text-light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Assistant', sans-serif;
            white-space: nowrap;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        .header-button:hover {
            background: var(--pleasure-primary);
            color: white;
            border-color: var(--pleasure-primary);
            transform: translateY(-2px);
        }
        
        .back-button {
            background: transparent;
            border: 1px solid var(--pleasure-border);
            border-radius: 12px;
            padding: 8px 16px;
            color: var(--pleasure-text-light);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Assistant', sans-serif;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: var(--pleasure-primary);
            color: white;
            border-color: var(--pleasure-primary);
            transform: translateY(-2px);
        }
        
        /* View Container */
        .view-container {
            display: none;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            box-sizing: border-box;
        }
        
        .view-container.active {
            display: block;
        }
        
        /* Hero Section */
        .hero-section {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 30px 40px;
            text-align: center;
        }
        
        .hero-title {
            font-size: 42px;
            font-weight: 800;
            color: var(--pleasure-text);
            margin-bottom: 15px;
            line-height: 1.2;
        }
        
        .hero-subtitle {
            font-size: 20px;
            font-weight: 300;
            color: var(--pleasure-text-light);
            line-height: 1.6;
        }
        
        /* Album Grid - Bento Style */
        .albums-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px 40px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
            gap: 20px;
            margin-top: 40px;
        }
        
        .album-card {
            background: rgba(255, 254, 247, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid var(--pleasure-border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--pleasure-shadow);
            position: relative;
            aspect-ratio: 4 / 5;
            display: flex;
            flex-direction: column;
        }
        
        .album-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--pleasure-shadow-hover);
            border-color: var(--pleasure-primary);
        }
        
        .album-cover {
            width: 100%;
            aspect-ratio: 4 / 5;
            background: linear-gradient(135deg, var(--pleasure-bg-start), var(--pleasure-bg-end));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .album-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .album-info {
            padding: 20px;
            background: rgba(255, 254, 247, 0.98);
        }
        
        .album-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--pleasure-text);
            margin-bottom: 8px;
        }
        
        .album-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 20;
            pointer-events: none;
        }
        
        .album-card:hover .album-actions {
            opacity: 1;
            pointer-events: auto;
        }
        
        .action-btn {
            background: rgba(183, 110, 121, 0.95);
            border: 2px solid #B76E79;
            border-radius: 8px;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            color: white;
            z-index: 21;
            pointer-events: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .action-btn:hover {
            background: #B76E79;
            color: white;
            border-color: #B76E79;
            transform: scale(1.15);
            box-shadow: 0 4px 16px rgba(183, 110, 121, 0.5);
        }
        
        /* Entries Grid */
        .entries-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 30px 40px;
        }
        
        .entries-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
            gap: 20px;
            margin-top: 40px;
        }
        
        .entry-card {
            background: rgba(255, 254, 247, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid var(--pleasure-border);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--pleasure-shadow);
            position: relative;
            aspect-ratio: 4 / 5;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .entry-card.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .entry-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--pleasure-shadow-hover);
            border-color: var(--pleasure-primary);
        }
        
        .entry-actions {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .entry-card:hover .entry-actions {
            opacity: 1;
        }
        
        .entry-media {
            width: 100%;
            aspect-ratio: 4 / 5;
            background: linear-gradient(135deg, var(--pleasure-bg-start), var(--pleasure-bg-end));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--pleasure-text-light);
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }
        
        .entry-media img,
        .entry-media video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .entry-content {
            padding: 20px;
            background: rgba(255, 254, 247, 0.98);
            backdrop-filter: blur(10px);
        }
        
        .entry-date {
            font-size: 12px;
            font-weight: 600;
            color: var(--pleasure-primary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .entry-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .entry-tag {
            font-size: 11px;
            padding: 4px 8px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 6px;
            color: var(--pleasure-primary);
            font-weight: 600;
        }
        
        .entry-preview {
            font-size: 14px;
            font-weight: 400;
            color: var(--pleasure-text);
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 30px;
            color: var(--pleasure-text-light);
            grid-column: 1 / -1;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--pleasure-text);
        }
        
        .empty-state-text {
            font-size: 16px;
            font-weight: 300;
            line-height: 1.6;
        }
        
        /* Search Container */
        .search-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 30px 0;
        }
        
        .search-input {
            width: 100%;
            background: rgba(255, 254, 247, 0.95);
            border: 2px solid var(--pleasure-border);
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 16px;
            font-family: 'Assistant', sans-serif;
            color: var(--pleasure-text);
            direction: rtl;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--pleasure-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        /* FAB */
        .fab {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--pleasure-primary);
            color: white;
            border: none;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            box-shadow: var(--pleasure-shadow-hover);
            transition: all 0.3s ease;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Assistant', sans-serif;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 16px 48px rgba(212, 175, 55, 0.4);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            direction: rtl;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: var(--pleasure-cream);
            border-radius: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 24px 30px;
            border-bottom: 1px solid var(--pleasure-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--pleasure-text);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            font-size: 32px;
            color: var(--pleasure-text-light);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--pleasure-primary);
        }
        
        .modal-body {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 24px 30px;
            border-top: 1px solid var(--pleasure-border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--pleasure-text);
            margin-bottom: 8px;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--pleasure-border);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Assistant', sans-serif;
            color: var(--pleasure-text);
            background: rgba(255, 254, 247, 0.95);
            transition: all 0.3s ease;
            direction: rtl;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--pleasure-primary);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Assistant', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background: var(--pleasure-primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--pleasure-accent);
            transform: translateY(-2px);
            box-shadow: var(--pleasure-shadow);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--pleasure-text-light);
            border: 2px solid var(--pleasure-border);
        }
        
        .btn-secondary:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--pleasure-primary);
            color: var(--pleasure-primary);
        }
        
        /* File Upload */
        .file-upload-area {
            border: 3px dashed var(--pleasure-border);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 254, 247, 0.5);
        }
        
        .file-upload-area:hover {
            border-color: var(--pleasure-primary);
            background: rgba(212, 175, 55, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: var(--pleasure-primary);
            background: rgba(212, 175, 55, 0.15);
            border-width: 3px;
            transform: scale(1.02);
        }
        
        .file-upload-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .file-upload-text {
            font-size: 14px;
            color: var(--pleasure-text-light);
            margin-bottom: 8px;
        }
        
        .file-upload-hint {
            font-size: 12px;
            color: var(--pleasure-text-light);
            opacity: 0.7;
        }
        
        .file-preview {
            margin-top: 16px;
            display: none;
        }
        
        .file-preview.show {
            display: block;
        }
        
        .file-preview img,
        .file-preview video {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 40px;
            direction: rtl;
        }
        
        .lightbox.show {
            display: flex;
        }
        
        .lightbox-content {
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            gap: 40px;
            align-items: center;
            color: white;
        }
        
        .lightbox-media {
            flex: 1;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-media img,
        .lightbox-media video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 12px;
            object-fit: contain;
        }
        
        .lightbox-narrative {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            max-height: 90vh;
        }
        
        .lightbox-narrative h3 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--pleasure-primary);
        }
        
        .lightbox-narrative p {
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 32px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 3001;
        }
        
        .lightbox-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 767px) {
            /* Mobile Header Layout */
            .journal-header {
                padding: 15px 20px;
            }
            
            .journal-title {
                font-size: 1.2rem;
            }
            
            .header-actions {
                gap: 5px;
            }
            
            .header-button {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .search-input-header {
                width: 200px;
                max-width: calc(100vw - 200px);
            }
            
            /* Lightbox Mobile */
            .lightbox-content {
                flex-direction: column;
                gap: 20px;
            }
            
            .lightbox-narrative {
                padding: 20px;
            }
            
            /* Prevent horizontal overflow */
            .header-content {
                min-width: 0;
                max-width: 100vw;
            }
            
            .journal-title {
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            /* Grid containers mobile */
            .albums-container,
            .entries-container {
                padding: 0 15px 30px;
            }
            
            .albums-grid,
            .entries-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            /* Hero section mobile */
            .hero-section {
                padding: 40px 20px 30px;
            }
            
            .hero-title {
                font-size: 28px;
            }
            
            .hero-subtitle {
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            /* Absolute final mobile fixes - prevent any overflow */
            * {
                max-width: 100vw;
                box-sizing: border-box;
            }
            
            /* Header 'Hammer' Fix */
            .journal-header {
                padding: 10px 5px;
                overflow: hidden;
            }
            
            .header-actions {
                gap: 2px;
            }
            
            .header-button {
                font-size: 10px;
                padding: 4px 6px;
                min-width: auto;
            }
            
            .journal-title {
                font-size: 1rem;
                letter-spacing: -0.5px;
            }
            
            /* Ensure header fits */
            .header-content {
                padding: 0 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <img src="/assets/icon.png?v=3" alt="×™×•××Ÿ ×“× ×™×ª" class="splash-icon">
    </div>
    
    <!-- Header -->
    <header class="journal-header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="back-button" id="back-to-home" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    ×—×–×¨×”
                </button>
                <a href="./index.html" class="back-button" id="back-to-site" aria-label="×—×–×¨×” ×œ×¢××•×“ ×”×‘×™×ª">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    ×—×–×¨×”
                </a>
                <h1 class="journal-title">
                    <svg class="journal-title-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5 19.5 21l1.74-8.76z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <path d="M16 8L2 22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    ×™×•××Ÿ ×“× ×™×ª
                </h1>
            </div>
            <div class="header-actions">
                <input type="text" class="search-input-header" id="header-search-input" placeholder="×—×¤×©×™ ×‘×›×œ ×”×ª×•×›×Ÿ..." style="display: none;">
                <button class="header-button" id="search-btn">×—×™×¤×•×©</button>
                <button class="header-button" id="settings-btn">×”×’×“×¨×•×ª</button>
            </div>
        </div>
    </header>
    
    <!-- Home View - Album Grid -->
    <div class="view-container active" id="home-view">
        <section class="hero-section">
            <h2 class="hero-title">×‘×¨×•×›×” ×”×‘××” ×œ×™×•××Ÿ ×©×œ×š</h2>
            <p class="hero-subtitle">×›×œ ×¨×’×¢, ×›×œ ×–×™×›×¨×•×Ÿ, ×›×œ ×¡×™×¤×•×¨ - ×›××Ÿ ××ª×—×‘×¨×™× ×™×—×“ ×œ×¡×™×¤×•×¨ ×—×™×™× ××—×“ ××ª××©×š</p>
        </section>
        
        <section class="albums-container">
            <div class="albums-grid" id="albums-grid">
                <!-- Albums will be rendered here -->
            </div>
        </section>
    </div>
    
    <!-- Album Entries View -->
    <div class="view-container" id="album-entries-view">
        <section class="hero-section">
            <h2 class="hero-title" id="album-title-header">××œ×‘×•×</h2>
        </section>
        
        <section class="entries-container">
            <div class="entries-grid" id="entries-grid">
                <!-- Entries will be rendered here -->
            </div>
        </section>
    </div>
    
    <!-- Floating Action Button -->
    <button class="fab" id="fab-btn" aria-label="×”×•×¡×£">
        +
    </button>
    
    <!-- Add Album Modal -->
    <div class="modal-overlay" id="add-album-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">×”×•×¡×¤×ª ××œ×‘×•× ×—×“×©</h2>
                <button class="modal-close" id="close-add-album-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="add-album-form">
                    <div class="form-group">
                        <label class="form-label" for="album-title">×©× ×”××œ×‘×•×</label>
                        <input type="text" id="album-title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="album-base-prompt">Base Prompt ×œ××œ×‘×•×</label>
                        <textarea id="album-base-prompt" class="form-textarea" rows="6" placeholder="×›×ª×‘×™ ×”×•×¨××•×ª ×¡×¤×¦×™×¤×™×•×ª ×œ××œ×‘×•× ×”×–×”..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××•× ×ª ×›×™×¡×•×™</label>
                        <div class="file-upload-area" id="album-cover-upload-area">
                            <div class="file-upload-icon">ğŸ–¼ï¸</div>
                            <div class="file-upload-text">×’×¨×•×¨ ×ª××•× ×” ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
                            <input type="file" id="album-cover-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="file-preview" id="album-cover-preview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-add-album-btn">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="save-add-album-btn">×©××•×¨</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Album Modal -->
    <div class="modal-overlay" id="edit-album-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">×¢×¨×™×›×ª ××œ×‘×•×</h2>
                <button class="modal-close" id="close-edit-album-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="edit-album-form">
                    <div class="form-group">
                        <label class="form-label" for="edit-album-title">×©× ×”××œ×‘×•×</label>
                        <input type="text" id="edit-album-title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-album-base-prompt">Base Prompt ×œ××œ×‘×•×</label>
                        <textarea id="edit-album-base-prompt" class="form-textarea" rows="6"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">×ª××•× ×ª ×›×™×¡×•×™</label>
                        <div class="file-upload-area" id="edit-album-cover-upload-area">
                            <div class="file-upload-icon">ğŸ–¼ï¸</div>
                            <div class="file-upload-text">×’×¨×•×¨ ×ª××•× ×” ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
                            <input type="file" id="edit-album-cover-input" accept="image/*" style="display: none;">
                        </div>
                        <div class="file-preview" id="edit-album-cover-preview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-edit-album-btn">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="save-edit-album-btn">×©××•×¨</button>
            </div>
        </div>
    </div>
    
    <!-- Add Moment Modal -->
    <div class="modal-overlay" id="add-moment-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">×”×•×¡×¤×ª ×¨×’×¢ ×—×“×©</h2>
                <button class="modal-close" id="close-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="add-moment-form">
                    <div class="form-group">
                        <label class="form-label" for="moment-album">××œ×‘×•×</label>
                        <select id="moment-album" class="form-input" required style="padding: 12px 16px;">
                            <option value="">×‘×—×¨×™ ××œ×‘×•×...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">×ª××•× ×” ××• ×¡×¨×˜×•×Ÿ</label>
                        <div class="file-upload-area" id="file-upload-area">
                            <div class="file-upload-icon">ğŸ“·</div>
                            <div class="file-upload-text">×’×¨×•×¨ ×§×‘×¦×™× ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</div>
                            <div class="file-upload-hint">PNG, JPG, MP4 ×¢×“ 10MB</div>
                            <input type="file" id="media-input" accept="image/*,video/*" style="display: none;" multiple>
                        </div>
                        <div class="file-preview" id="file-preview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="moment-date">×ª××¨×™×š</label>
                        <input type="date" id="moment-date" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="personal-notes">×”×¢×¨×•×ª ××™×©×™×•×ª</label>
                        <textarea id="personal-notes" class="form-textarea" placeholder="×›×ª×‘×™ ×›××” ××™×œ×™× ×¢×œ ×”×¨×’×¢ ×”×–×”..." rows="4"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="moment-tags">×ª×’×™×•×ª (××•×¤×¨×“×•×ª ×‘×¨×•×•×— ××• ×¤×¡×™×§)</label>
                        <input type="text" id="moment-tags" class="form-input" placeholder="×‘×•×§×¨ ×§×¤×” ×©×œ×•×•×”">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-btn">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="save-moment-btn">
                    <span id="save-moment-text">×©××•×¨ ×•×™×¦×•×¨ ×¡×™×¤×•×¨</span>
                    <span id="save-moment-loading" class="loading" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Edit Entry Modal -->
    <div class="modal-overlay" id="edit-entry-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">×¢×¨×™×›×ª ×¨×’×¢</h2>
                <button class="modal-close" id="close-edit-entry-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="edit-entry-form">
                    <div class="form-group">
                        <label class="form-label">××“×™×” × ×•×›×—×™×ª</label>
                        <div class="file-preview" id="edit-entry-preview"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-entry-personal-notes">×”×¢×¨×•×ª ××™×©×™×•×ª</label>
                        <textarea id="edit-entry-personal-notes" class="form-textarea" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="edit-entry-tags">×ª×’×™×•×ª (××•×¤×¨×“×•×ª ×‘×¤×¡×™×§)</label>
                        <input type="text" id="edit-entry-tags" class="form-input" placeholder="×‘×•×§×¨ ×§×¤×” ×©×œ×•×•×”">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-edit-entry-btn">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="save-edit-entry-btn">×©××•×¨</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">×”×’×“×¨×•×ª</h2>
                <button class="modal-close" id="close-settings-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="global-prompt">System Prompt ×’×œ×•×‘×œ×™</label>
                    <textarea id="global-prompt" class="form-textarea" rows="12"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-settings-btn">×‘×™×˜×•×œ</button>
                <button type="button" class="btn btn-primary" id="save-settings-btn">×©××•×¨</button>
            </div>
        </div>
    </div>
    
    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" id="lightbox-close">Ã—</button>
        <div class="lightbox-content">
            <div class="lightbox-media" id="lightbox-media"></div>
            <div class="lightbox-narrative" id="lightbox-narrative"></div>
        </div>
    </div>
    
    <script>
        // Data
        let journalEntries = [];
        let albums = [];
        let settings = {};
        let selectedFiles = [];
        let selectedAlbumCover = null;
        let selectedEditAlbumCover = null;
        let currentView = 'home'; // 'home' or 'album'
        let currentAlbumId = null;
        let editingAlbumId = null;
        
        // Format date as DD/MM/YYYY - FORCED HARD LOGIC (NO TIME)
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL').replace(/\./g, '/');
        }
        
        // Load data from SERVER ONLY (NO LOCALSTORAGE, NO DEFAULT ALBUMS)
        async function loadData() {
            try {
                const response = await fetch('/api/load-data');
                if (!response.ok) {
                    throw new Error('Failed to load data from server');
                }
                const data = await response.json();
                
                // Load ONLY from server - no defaults, no localStorage
                journalEntries = data.journal?.entries || [];
                albums = data.journal?.albums || [];
                settings = data.journal?.settings || {};
                
                // Remove default albums - filter out hardcoded ones
                const defaultAlbumIds = ['album-1', 'album-2', 'album-3'];
                albums = albums.filter(album => {
                    // Filter out default albums by ID
                    if (defaultAlbumIds.includes(album.id)) {
                        return false;
                    }
                    // Also filter out any album with default titles
                    const defaultTitles = ['×¨×’×¢×™× ×™×•××™×•××™×™×', '××¡×¢×•×ª ×•×”×¨×¤×ª×§××•×ª', '×¨×’×¢×™× ×¢× ×× ×©×™× ××”×•×‘×™×'];
                    if (defaultTitles.includes(album.title)) {
                        return false;
                    }
                    return album && album.id && album.title;
                });
                
                // Also remove entries from default albums
                journalEntries = journalEntries.filter(entry => {
                    return !defaultAlbumIds.includes(entry.albumId);
                });
                
                journalEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderHomeView();
                
                // Hide splash screen after successful data load
                const splashScreen = document.getElementById('splash-screen');
                if (splashScreen) {
                    splashScreen.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // Show empty state if server fails
                journalEntries = [];
                albums = [];
                settings = {};
                renderHomeView();
                
                // Hide splash screen even on error (show empty state)
                const splashScreen = document.getElementById('splash-screen');
                if (splashScreen) {
                    splashScreen.classList.add('hidden');
                }
            }
        }
        
        // Save data to SERVER ONLY (NO LOCALSTORAGE)
        async function saveData() {
            try {
                const response = await fetch('/api/save-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        albums: albums,
                        entries: journalEntries,
                        settings: settings
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Backend save failed: ${errorText}`);
                }
                
                console.log('âœ… Data saved to server successfully');
            } catch (error) {
                console.error('âŒ Error saving to server:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”× ×ª×•× ×™×. ×× × × ×¡×™ ×©×•×‘.');
                throw error;
            }
        }
        
        // Delete media file from server
        async function deleteMediaFile(filePath) {
            if (!filePath || !filePath.startsWith('/assets/journal/')) {
                return; // Skip if no file or not a server file
            }
            
            try {
                const response = await fetch('/api/delete-media', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filePath: filePath })
                });
                
                if (!response.ok) {
                    console.warn('Failed to delete media file:', filePath);
                }
            } catch (error) {
                console.warn('Error deleting media file:', error);
            }
        }
        
        // Render Home View (Albums)
        function renderHomeView() {
            const grid = document.getElementById('albums-grid');
            
            if (albums.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“š</div>
                        <h3 class="empty-state-title">××™×Ÿ ××œ×‘×•××™× ×¢×“×™×™×Ÿ</h3>
                        <p class="empty-state-text">×¦×¨×™ ××œ×‘×•× ×—×“×© ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = albums.map(album => `
                <div class="album-card" data-album-id="${album.id}">
                    <div class="album-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); editAlbum('${album.id}')">âœï¸</button>
                        <button class="action-btn" onclick="event.stopPropagation(); deleteAlbum('${album.id}')">ğŸ—‘ï¸</button>
                    </div>
                    <div class="album-cover">
                        ${album.coverImage ? `<img src="${album.coverImage}" alt="${album.title}">` : '<div style="font-size: 64px; opacity: 0.3;">ğŸ“š</div>'}
                    </div>
                    <div class="album-info">
                        <div class="album-title">${album.title}</div>
                    </div>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('.album-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.album-actions')) return;
                    const albumId = this.dataset.albumId;
                    showAlbumEntries(albumId);
                });
            });
        }
        
        // Show Album Entries
        async function showAlbumEntries(albumId) {
            try {
                console.log(`ğŸ“‚ [CLIENT] Opening album: ${albumId}`);
                currentView = 'album';
                currentAlbumId = albumId;
                const album = albums.find(a => a.id === albumId);
                
                if (!album) {
                    console.error(`âŒ [CLIENT] Album not found: ${albumId}`);
                    alert('××œ×‘×•× ×œ× × ××¦×');
                    return;
                }
                
                console.log(`âœ… [CLIENT] Album found: ${album.title}`);
                
                document.getElementById('home-view').classList.remove('active');
                document.getElementById('album-entries-view').classList.add('active');
                document.getElementById('back-to-home').style.display = 'inline-flex';
                document.getElementById('back-to-site').style.display = 'none';
                document.getElementById('album-title-header').textContent = album.title;
                
                // Filter and render entries for this album
                const albumEntries = journalEntries.filter(e => e.albumId === albumId);
                console.log(`ğŸ“¸ [CLIENT] Rendering ${albumEntries.length} entries for album ${albumId}`);
                
                renderEntries(albumEntries);
            } catch (error) {
                console.error('âŒ [CLIENT] Error opening album:', error);
                alert('×©×’×™××” ×‘×¤×ª×™×—×ª ×”××œ×‘×•×: ' + error.message);
            }
        }
        
        // Render Entries
        function renderEntries(filteredEntries = null) {
            const grid = document.getElementById('entries-grid');
            const entriesToShow = filteredEntries || journalEntries.filter(e => !currentAlbumId || e.albumId === currentAlbumId);
            
            if (entriesToShow.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“–</div>
                        <h3 class="empty-state-title">××™×Ÿ ×›× ×™×¡×•×ª ×¢×“×™×™×Ÿ</h3>
                        <p class="empty-state-text">×”×•×¡×™×¤×™ ×¨×’×¢ ×—×“×© ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = entriesToShow.map((entry, index) => {
                const tags = entry.tags || [];
                // Ensure mediaUrl is a valid path (case-sensitive for Linux)
                let mediaUrl = entry.mediaUrl || '';
                if (mediaUrl && !mediaUrl.startsWith('http') && !mediaUrl.startsWith('/')) {
                    mediaUrl = '/' + mediaUrl;
                }
                
                // Log image loading for debugging
                if (entry.mediaType === 'image' && mediaUrl) {
                    console.log(`ğŸ–¼ï¸ [CLIENT] Loading image: ${mediaUrl} for entry ${entry.id}`);
                }
                
                return `
                    <div class="entry-card visible" data-entry-id="${entry.id}">
                        <div class="entry-actions">
                            <button class="action-btn" onclick="event.stopPropagation(); editEntry('${entry.id}')">âœï¸</button>
                            <button class="action-btn" onclick="event.stopPropagation(); deleteEntry('${entry.id}')">ğŸ—‘ï¸</button>
                        </div>
                        <div class="entry-media">
                            ${entry.mediaType === 'image' && mediaUrl ? 
                                `<img src="${mediaUrl}" alt="×¨×’×¢ ${index + 1}" loading="lazy" onerror="console.error('âŒ [CLIENT] Failed to load image: ${mediaUrl}')">` :
                                entry.mediaType === 'video' && mediaUrl ?
                                `<video src="${mediaUrl}" controls onerror="console.error('âŒ [CLIENT] Failed to load video: ${mediaUrl}')"></video>` :
                                '<div style="font-size: 48px;">ğŸ“·</div>'
                            }
                        </div>
                        <div class="entry-content">
                            <div class="entry-date">${formatDate(entry.date)}</div>
                            ${tags.length > 0 ? `<div class="entry-tags">${tags.map(t => `<span class="entry-tag">#${t.replace(/^#/, '')}</span>`).join('')}</div>` : ''}
                            <div class="entry-preview">${entry.narrative ? entry.narrative : (entry.personalNotes || '×¨×’×¢ ××™×•×—×“')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add click handlers for lightbox (but not on action buttons)
            document.querySelectorAll('.entry-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.entry-actions')) return;
                    const entryId = this.dataset.entryId;
                    showLightbox(entryId);
                });
            });
        }
        
        // Show Lightbox - FIXED: Use server path for images
        function showLightbox(entryId) {
            const entry = journalEntries.find(e => e.id === entryId);
            if (!entry) {
                console.error('Entry not found:', entryId);
                return;
            }
            
            const mediaDiv = document.getElementById('lightbox-media');
            const narrativeDiv = document.getElementById('lightbox-narrative');
            
            // Use server path for media
            const mediaUrl = entry.mediaUrl || '';
            
            if (entry.mediaType === 'image' && mediaUrl) {
                mediaDiv.innerHTML = `<img src="${mediaUrl}" alt="×¨×’×¢" style="max-width: 100%; max-height: 90vh; object-fit: contain;">`;
            } else if (entry.mediaType === 'video' && mediaUrl) {
                mediaDiv.innerHTML = `<video src="${mediaUrl}" controls autoplay style="max-width: 100%; max-height: 90vh;"></video>`;
            } else {
                mediaDiv.innerHTML = '<div style="font-size: 64px; opacity: 0.5;">ğŸ“–</div>';
            }
            
            const tags = entry.tags || [];
            narrativeDiv.innerHTML = `
                <h3>${formatDate(entry.date)}</h3>
                ${tags.length > 0 ? `<div style="margin-bottom: 20px;">${tags.map(t => `<span class="entry-tag">#${t.replace(/^#/, '')}</span>`).join('')}</div>` : ''}
                <p>${entry.narrative ? entry.narrative : (entry.personalNotes || '×¨×’×¢ ××™×•×—×“')}</p>
            `;
            
            document.getElementById('lightbox').classList.add('show');
        }
        
        // Upload media file to server and return path
        async function uploadMediaFile(file) {
            try {
                // Convert to base64
                const base64Data = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                // Upload to server
                const response = await fetch('/api/upload-media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base64Data: base64Data,
                        mediaType: file.type.startsWith('video/') ? 'video' : 'image'
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${errorText}`);
                }
                
                const result = await response.json();
                // Support both new format (url) and old format (filePath) for backward compatibility
                return result.url || result.filePath; // Returns /assets/journal/filename.jpg
            } catch (error) {
                console.log('Full Error:', error);
                alert('Check console for details');
                throw error;
            }
        }
        
        // Generate Narrative - FIXED: Properly await and return narrative
        async function generateNarrative(personalNotes, mediaType, previousEntries, globalPrompt = '', albumPrompt = '') {
            try {
                console.log('ğŸ¤– Generating narrative with:', {
                    hasPersonalNotes: !!personalNotes,
                    mediaType: mediaType,
                    previousEntriesCount: previousEntries.length,
                    hasGlobalPrompt: !!globalPrompt,
                    hasAlbumPrompt: !!albumPrompt
                });
                
                const response = await fetch('/api/generate-story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        personalNotes: personalNotes,
                        mediaType: mediaType,
                        previousEntries: previousEntries,
                        globalPrompt: globalPrompt || '',
                        albumBasePrompt: albumPrompt || ''
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                const narrative = data.narrative ? data.narrative.trim() : '';
                
                if (!narrative) {
                    throw new Error('Empty narrative received from AI');
                }
                
                console.log('âœ… Narrative generated:', narrative.substring(0, 100) + '...');
                return narrative;
            } catch (error) {
                console.error('âŒ AI generation error:', error);
                throw error; // Re-throw to handle in save function
            }
        }
        
        // Edit Album - FIXED: Opens modal with current data
        function editAlbum(albumId) {
            const album = albums.find(a => a.id === albumId);
            if (!album) {
                console.error('Album not found:', albumId);
                return;
            }
            
            editingAlbumId = albumId;
            document.getElementById('edit-album-title').value = album.title;
            document.getElementById('edit-album-base-prompt').value = album.basePrompt || '';
            document.getElementById('edit-album-cover-preview').innerHTML = '';
            selectedEditAlbumCover = null;
            
            // Show current cover image with server path
            if (album.coverImage) {
                const img = document.createElement('img');
                const coverUrl = album.coverImage;
                img.src = coverUrl;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '200px';
                img.style.borderRadius = '8px';
                document.getElementById('edit-album-cover-preview').appendChild(img);
            }
            
            document.getElementById('edit-album-modal').classList.add('show');
        }
        
        // Delete Album - FIXED: Proper confirmation and backend save
        async function deleteAlbum(albumId) {
            if (!confirm('×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××œ×‘×•× ×•×›×œ ×ª×›× ×™×•?')) return;
            
            const album = albums.find(a => a.id === albumId);
            if (!album) return;
            
            try {
                // Delete album cover image if exists
                if (album.coverImage && album.coverImage.startsWith('/assets/journal/')) {
                    await deleteMediaFile(album.coverImage);
                }
                
                // Delete all entry media files in this album
                const entriesToDelete = journalEntries.filter(e => e.albumId === albumId);
                for (const entry of entriesToDelete) {
                    if (entry.mediaUrl && entry.mediaUrl.startsWith('/assets/journal/')) {
                        await deleteMediaFile(entry.mediaUrl);
                    }
                }
                
                // Remove from arrays
                albums = albums.filter(a => a.id !== albumId);
                journalEntries = journalEntries.filter(e => e.albumId !== albumId);
                
                // Save to backend immediately
                await saveData();
                
                // Update UI immediately
                renderHomeView();
                
                // If we're viewing this album, go back to home
                if (currentView === 'album' && currentAlbumId === albumId) {
                    currentView = 'home';
                    currentAlbumId = null;
                    document.getElementById('home-view').classList.add('active');
                    document.getElementById('album-entries-view').classList.remove('active');
                    document.getElementById('back-to-home').style.display = 'none';
                    document.getElementById('back-to-site').style.display = 'inline-flex';
                    renderHomeView();
                }
            } catch (error) {
                console.error('Error deleting album:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”××œ×‘×•×: ' + error.message);
            }
        }
        
        // Delete Entry - FIXED: Proper persistence to backend
        async function deleteEntry(entryId) {
            if (!confirm('×”×× ××ª ×‘×˜×•×—×” ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¨×’×¢ ×”×–×”?')) return;
            
            const entry = journalEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            try {
                // Delete media file if exists
                if (entry.mediaUrl && entry.mediaUrl.startsWith('/assets/journal/')) {
                    await deleteMediaFile(entry.mediaUrl);
                }
                
                // Remove from array
                journalEntries = journalEntries.filter(e => e.id !== entryId);
                
                // Save to backend immediately
                await saveData();
                
                // Update UI
                if (currentView === 'album') {
                    renderEntries();
                } else {
                    renderHomeView();
                }
            } catch (error) {
                console.error('Error deleting entry:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×¨×’×¢: ' + error.message);
            }
        }
        
        // Edit Entry
        let editingEntryId = null;
        function editEntry(entryId) {
            const entry = journalEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            editingEntryId = entryId;
            document.getElementById('edit-entry-personal-notes').value = entry.personalNotes || '';
            document.getElementById('edit-entry-tags').value = (entry.tags || []).join(', ');
            
            // Show current media if exists
            const previewDiv = document.getElementById('edit-entry-preview');
            previewDiv.innerHTML = '';
            if (entry.mediaUrl) {
                const mediaUrl = entry.mediaUrl;
                if (entry.mediaType === 'image') {
                    previewDiv.innerHTML = `<img src="${mediaUrl}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">`;
                } else if (entry.mediaType === 'video') {
                    previewDiv.innerHTML = `<video src="${mediaUrl}" controls style="max-width: 100%; max-height: 200px; border-radius: 8px;"></video>`;
                }
            }
            
            document.getElementById('edit-entry-modal').classList.add('show');
        }
        
        // Back to Home
        document.getElementById('back-to-home').addEventListener('click', () => {
            currentView = 'home';
            currentAlbumId = null;
            document.getElementById('home-view').classList.add('active');
            document.getElementById('album-entries-view').classList.remove('active');
            document.getElementById('back-to-home').style.display = 'none';
            document.getElementById('back-to-site').style.display = 'inline-flex';
            renderHomeView();
        });
        
        // FAB Button
        document.getElementById('fab-btn').addEventListener('click', () => {
            if (currentView === 'home') {
                document.getElementById('add-album-modal').classList.add('show');
            } else {
                // Reset form
                document.getElementById('add-moment-form').reset();
                selectedFiles = [];
                document.getElementById('file-preview').innerHTML = '';
                document.getElementById('file-preview').classList.remove('show');
                
                // Set default date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                document.getElementById('moment-date').value = dateStr;
                
                // Populate album select
                const albumSelect = document.getElementById('moment-album');
                albumSelect.innerHTML = '<option value="">×‘×—×¨×™ ××œ×‘×•×...</option>' + 
                    albums.map(a => `<option value="${a.id}" ${a.id === currentAlbumId ? 'selected' : ''}>${a.title}</option>`).join('');
                
                document.getElementById('add-moment-modal').classList.add('show');
            }
        });
        
        // Search
        let searchActive = false;
        document.getElementById('search-btn').addEventListener('click', () => {
            const searchInput = document.getElementById('header-search-input');
            searchActive = !searchActive;
            searchInput.style.display = searchActive ? 'block' : 'none';
            if (searchActive) {
                searchInput.focus();
            } else {
                searchInput.value = '';
                if (currentView === 'home') {
                    renderHomeView();
                } else {
                    renderEntries();
                }
            }
        });
        
        document.getElementById('header-search-input').addEventListener('input', (e) => {
            const query = e.target.value.trim().toLowerCase();
            if (!query) {
                if (currentView === 'home') {
                    renderHomeView();
                } else {
                    renderEntries();
                }
                return;
            }
            
            // Search through albums, narratives, tags
            if (currentView === 'home') {
                const filtered = albums.filter(album => {
                    const titleLower = (album.title || '').toLowerCase();
                    return titleLower.includes(query);
                });
                document.getElementById('albums-grid').innerHTML = filtered.map(album => `
                    <div class="album-card" data-album-id="${album.id}">
                        <div class="album-cover">
                            ${album.coverImage ? `<img src="${album.coverImage}" alt="${album.title}">` : '<div style="font-size: 64px; opacity: 0.3;">ğŸ“š</div>'}
                        </div>
                        <div class="album-info">
                            <div class="album-title">${album.title}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                const filtered = journalEntries.filter(entry => {
                    const narrativeLower = (entry.narrative || '').toLowerCase();
                    const notesLower = (entry.personalNotes || '').toLowerCase();
                    const tagsLower = (entry.tags || []).map(t => t.toLowerCase()).join(' ');
                    const album = albums.find(a => a.id === entry.albumId);
                    const albumTitleLower = (album?.title || '').toLowerCase();
                    const searchText = narrativeLower + ' ' + notesLower + ' ' + tagsLower + ' ' + albumTitleLower;
                    return searchText.includes(query) && (!currentAlbumId || entry.albumId === currentAlbumId);
                });
                renderEntries(filtered);
            }
        });
        
        // Settings
        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('global-prompt').value = settings.globalSystemPrompt || '';
            document.getElementById('settings-modal').classList.add('show');
        });
        
        document.getElementById('save-settings-btn').addEventListener('click', () => {
            settings.globalSystemPrompt = document.getElementById('global-prompt').value.trim();
            saveData();
            document.getElementById('settings-modal').classList.remove('show');
        });
        
        document.getElementById('close-settings-modal').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.remove('show');
        });
        
        document.getElementById('cancel-settings-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.remove('show');
        });
        
        // Add Album
        document.getElementById('album-cover-upload-area').addEventListener('click', () => {
            document.getElementById('album-cover-input').click();
        });
        
        document.getElementById('album-cover-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedAlbumCover = file;
                const url = URL.createObjectURL(file);
                document.getElementById('album-cover-preview').innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">`;
            }
        });
        
        document.getElementById('save-add-album-btn').addEventListener('click', async () => {
            const title = document.getElementById('album-title').value.trim();
            if (!title) {
                alert('×× × ×”×›× ×¡×™ ×©× ×œ××œ×‘×•×');
                return;
            }
            
            let coverImagePath = '';
            if (selectedAlbumCover) {
                try {
                    // Upload cover image to server
                    coverImagePath = await uploadMediaFile(selectedAlbumCover);
                } catch (error) {
                    alert('×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×ª ×”×›×™×¡×•×™: ' + error.message);
                    return;
                }
            }
            
            const newAlbum = {
                id: Date.now().toString(),
                title: title,
                coverImage: coverImagePath, // Server path, not base64
                basePrompt: document.getElementById('album-base-prompt').value.trim(),
                createdAt: new Date().toISOString()
            };
            
            albums.push(newAlbum);
            await saveData(); // Save to server via /api/save-data
            renderHomeView();
            
            document.getElementById('add-album-modal').classList.remove('show');
            document.getElementById('add-album-form').reset();
            selectedAlbumCover = null;
            document.getElementById('album-cover-preview').innerHTML = '';
        });
        
        document.getElementById('close-add-album-modal').addEventListener('click', () => {
            document.getElementById('add-album-modal').classList.remove('show');
        });
        
        document.getElementById('cancel-add-album-btn').addEventListener('click', () => {
            document.getElementById('add-album-modal').classList.remove('show');
        });
        
        // Edit Album
        document.getElementById('edit-album-cover-upload-area').addEventListener('click', () => {
            document.getElementById('edit-album-cover-input').click();
        });
        
        document.getElementById('edit-album-cover-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedEditAlbumCover = file;
                const url = URL.createObjectURL(file);
                document.getElementById('edit-album-cover-preview').innerHTML = `<img src="${url}" style="max-width: 100%; max-height: 200px; border-radius: 8px;">`;
            }
        });
        
        document.getElementById('save-edit-album-btn').addEventListener('click', async () => {
            const album = albums.find(a => a.id === editingAlbumId);
            if (!album) {
                console.error('Album not found for editing:', editingAlbumId);
                return;
            }
            
            try {
                // Update title and base prompt
                album.title = document.getElementById('edit-album-title').value.trim();
                album.basePrompt = document.getElementById('edit-album-base-prompt').value.trim();
                
                // Upload new cover image if selected
                if (selectedEditAlbumCover) {
                    try {
                        // Upload to server and get path
                        album.coverImage = await uploadMediaFile(selectedEditAlbumCover);
                    } catch (error) {
                        alert('×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×ª ×”×›×™×¡×•×™: ' + error.message);
                        return;
                    }
                }
                
                // Save to backend immediately
                await saveData();
                
                // Update UI
                renderHomeView();
                
                // Update header if viewing this album
                if (currentView === 'album' && currentAlbumId === editingAlbumId) {
                    document.getElementById('album-title-header').textContent = album.title;
                }
                
                // Close modal
                document.getElementById('edit-album-modal').classList.remove('show');
            } catch (error) {
                console.error('Error saving album edit:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×: ' + error.message);
            }
        });
        
        document.getElementById('close-edit-album-modal').addEventListener('click', () => {
            document.getElementById('edit-album-modal').classList.remove('show');
        });
        
        document.getElementById('cancel-edit-album-btn').addEventListener('click', () => {
            document.getElementById('edit-album-modal').classList.remove('show');
        });
        
        // Add Moment - Drag & Drop
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileInput = document.getElementById('media-input');
        const filePreview = document.getElementById('file-preview');
        
        fileUploadArea.addEventListener('click', () => fileInput.click());
        
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.add('dragover');
        });
        
        fileUploadArea.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.add('dragover');
        });
        
        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (!fileUploadArea.contains(e.relatedTarget)) {
                fileUploadArea.classList.remove('dragover');
            }
        });
        
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileUploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            const validFiles = files.filter(file => 
                file.type.startsWith('image/') || file.type.startsWith('video/')
            );
            
            if (validFiles.length > 0) {
                selectedFiles = validFiles;
                filePreview.innerHTML = '';
                validFiles.forEach(file => {
                    const url = URL.createObjectURL(file);
                    const isVideo = file.type.startsWith('video/');
                    const div = document.createElement('div');
                    div.innerHTML = isVideo ? 
                        `<video src="${url}" controls style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;"></video>` :
                        `<img src="${url}" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;">`;
                    filePreview.appendChild(div);
                });
                filePreview.classList.add('show');
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            selectedFiles = files;
            filePreview.innerHTML = '';
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                const isVideo = file.type.startsWith('video/');
                const div = document.createElement('div');
                div.innerHTML = isVideo ? 
                    `<video src="${url}" controls style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;"></video>` :
                    `<img src="${url}" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;">`;
                filePreview.appendChild(div);
            });
            filePreview.classList.add('show');
        });
        
        // Save Moment
        document.getElementById('save-moment-btn').addEventListener('click', async () => {
            const albumId = document.getElementById('moment-album').value;
            if (!albumId) {
                alert('×× × ×‘×—×¨×™ ××œ×‘×•×');
                return;
            }
            
            const dateInput = document.getElementById('moment-date').value;
            if (!dateInput) {
                alert('×× × ×‘×—×¨×™ ×ª××¨×™×š');
                return;
            }
            
            const personalNotes = document.getElementById('personal-notes').value.trim();
            const tagsInput = document.getElementById('moment-tags').value.trim();
            
            if (selectedFiles.length === 0 && !personalNotes) {
                alert('×× × ×”×•×¡×™×¤×™ ×ª××•× ×”/×¡×¨×˜×•×Ÿ ××• ×”×¢×¨×•×ª ××™×©×™×•×ª');
                return;
            }
            
            const saveBtn = document.getElementById('save-moment-btn');
            saveBtn.disabled = true;
            document.getElementById('save-moment-text').textContent = '×™×•×¦×¨ ×¡×™×¤×•×¨...';
            document.getElementById('save-moment-loading').style.display = 'inline-block';
            
            try {
                const album = albums.find(a => a.id === albumId);
                const globalPrompt = settings.globalSystemPrompt || '';
                const albumPrompt = album?.basePrompt || '';
                
                const albumPreviousEntries = journalEntries
                    .filter(e => e.albumId === albumId)
                    .slice(0, 5)
                    .map(e => ({
                        date: e.date,
                        personalNotes: e.personalNotes || '',
                        narrative: e.narrative || ''
                    }));
                
                const tags = tagsInput ? tagsInput.split(/[,\s]+/).map(t => t.trim().replace(/^#/, '')).filter(t => t) : [];
                
                // Process files
                const newEntries = [];
                
                if (selectedFiles.length > 0) {
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        
                        // Upload file to server FIRST
                        let mediaUrl = '';
                        try {
                            mediaUrl = await uploadMediaFile(file);
                        } catch (error) {
                            console.error('Error uploading file:', error);
                            alert(`×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥ ${i + 1}: ${error.message}`);
                            continue;
                        }
                        
                        const mediaType = file.type.startsWith('video/') ? 'video' : 'image';
                        
                        // Generate narrative - CRITICAL: AWAIT properly and verify it's saved BEFORE creating entry
                        console.log('â³ [File ' + (i + 1) + '] Waiting for AI narrative...');
                        let narrative = '';
                        try {
                            narrative = await generateNarrative(personalNotes, mediaType, albumPreviousEntries, globalPrompt, albumPrompt);
                            console.log('âœ… [File ' + (i + 1) + '] Narrative received:', narrative ? narrative.substring(0, 50) + '...' : 'EMPTY');
                            
                            if (!narrative || narrative.trim() === '') {
                                throw new Error('Empty narrative from AI');
                            }
                        } catch (error) {
                            console.error('âŒ [File ' + (i + 1) + '] AI generation failed:', error);
                            // Fallback to personal notes if AI fails
                            narrative = personalNotes || '×¨×’×¢ ××™×•×—×“ ×©× ×©××¨ ×œ×™×•××Ÿ.';
                        }
                        
                        // Create entry ONLY after narrative is received and verified
                        const newEntry = {
                            id: Date.now().toString() + '-' + i,
                            albumId: albumId,
                            date: new Date(dateInput).toISOString(),
                            mediaType: mediaType,
                            mediaUrl: mediaUrl, // Server path, not base64
                            personalNotes: personalNotes,
                            narrative: narrative, // AI-generated narrative - VERIFIED: saved before entry creation
                            tags: tags,
                            aiGenerated: true
                        };
                        
                        console.log('âœ… [File ' + (i + 1) + '] Entry created with narrative:', newEntry.narrative ? 'YES (' + newEntry.narrative.length + ' chars)' : 'NO');
                        newEntries.push(newEntry);
                        
                        // Add to previous entries for next iteration
                        albumPreviousEntries.unshift({
                            date: newEntry.date,
                            personalNotes: newEntry.personalNotes,
                            narrative: newEntry.narrative
                        });
                    }
                } else {
                    // Text entry only - still generate narrative
                    console.log('â³ [Text Entry] Waiting for AI narrative...');
                    let narrative = '';
                    try {
                        narrative = await generateNarrative(personalNotes, 'text', albumPreviousEntries, globalPrompt, albumPrompt);
                        console.log('âœ… [Text Entry] Narrative received:', narrative ? narrative.substring(0, 50) + '...' : 'EMPTY');
                        
                        if (!narrative || narrative.trim() === '') {
                            throw new Error('Empty narrative from AI');
                        }
                    } catch (error) {
                        console.error('âŒ [Text Entry] AI generation failed:', error);
                        // Fallback to personal notes if AI fails
                        narrative = personalNotes || '×¨×’×¢ ××™×•×—×“ ×©× ×©××¨ ×œ×™×•××Ÿ.';
                    }
                    
                    // Create entry ONLY after narrative is received and verified
                    const newEntry = {
                        id: Date.now().toString(),
                        albumId: albumId,
                        date: new Date(dateInput).toISOString(),
                        mediaType: 'text',
                        mediaUrl: '',
                        personalNotes: personalNotes,
                        narrative: narrative, // AI-generated narrative - VERIFIED: saved before entry creation
                        tags: tags,
                        aiGenerated: true
                    };
                    
                    console.log('âœ… [Text Entry] Entry created with narrative:', newEntry.narrative ? 'YES (' + newEntry.narrative.length + ' chars)' : 'NO');
                    newEntries.push(newEntry);
                }
                
                if (newEntries.length === 0) {
                    throw new Error('×œ× × ×•×¦×¨×• ×›× ×™×¡×•×ª ×—×“×©×•×ª');
                }
                
                // Add entries to array
                journalEntries.unshift(...newEntries);
                journalEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Save to server - narrative is already populated in entries
                console.log('ğŸ’¾ Saving ' + newEntries.length + ' entries to server...');
                await saveData();
                console.log('âœ… Entries saved successfully to data.json');
                
                document.getElementById('add-moment-modal').classList.remove('show');
                document.getElementById('add-moment-form').reset();
                selectedFiles = [];
                filePreview.innerHTML = '';
                filePreview.classList.remove('show');
                
                if (currentView === 'album' && currentAlbumId === albumId) {
                    renderEntries();
                } else {
                    renderHomeView();
                }
            } catch (error) {
                console.error('Error saving moment:', error);
                alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¨×’×¢: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                document.getElementById('save-moment-text').textContent = '×©××•×¨ ×•×™×¦×•×¨ ×¡×™×¤×•×¨';
                document.getElementById('save-moment-loading').style.display = 'none';
            }
        });
        
        // Edit Entry Modal Handlers
        document.getElementById('save-edit-entry-btn').addEventListener('click', async () => {
            const entry = journalEntries.find(e => e.id === editingEntryId);
            if (!entry) return;
            
            const newPersonalNotes = document.getElementById('edit-entry-personal-notes').value.trim();
            const tagsInput = document.getElementById('edit-entry-tags').value.trim();
            entry.tags = tagsInput ? tagsInput.split(/[,\s]+/).map(t => t.trim().replace(/^#/, '')).filter(t => t) : [];
            
            // Check if personal notes changed - if so, regenerate AI narrative
            const textChanged = entry.personalNotes !== newPersonalNotes;
            entry.personalNotes = newPersonalNotes;
            
            if (textChanged) {
                try {
                    console.log('ğŸ“ Personal notes changed, regenerating AI narrative...');
                    
                    // Get album and prompts (same logic as new entry)
                    const album = albums.find(a => a.id === entry.albumId);
                    const globalPrompt = settings.globalSystemPrompt || '';
                    const albumPrompt = album?.basePrompt || '';
                    
                    // Get previous entries from same album (excluding current entry)
                    const albumPreviousEntries = journalEntries
                        .filter(e => e.albumId === entry.albumId && e.id !== entry.id)
                        .sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // Generate new narrative with updated text
                    const mediaType = entry.mediaType || 'text';
                    const newNarrative = await generateNarrative(
                        newPersonalNotes,
                        mediaType,
                        albumPreviousEntries,
                        globalPrompt,
                        albumPrompt
                    );
                    
                    // Update entry with new narrative
                    entry.narrative = newNarrative;
                    console.log('âœ… Narrative regenerated:', newNarrative.substring(0, 50) + '...');
                } catch (error) {
                    console.error('âŒ Error regenerating narrative:', error);
                    // Keep existing narrative if regeneration fails
                    alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×™×¤×•×¨ ×—×“×©. ×”×¡×™×¤×•×¨ ×”×§×™×™× × ×©××¨.');
                }
            }
            
            // Save to backend
            await saveData();
            document.getElementById('edit-entry-modal').classList.remove('show');
            
            // Update UI immediately
            if (currentView === 'album') {
                renderEntries();
            } else {
                renderHomeView();
            }
        });
        
        document.getElementById('close-edit-entry-modal').addEventListener('click', () => {
            document.getElementById('edit-entry-modal').classList.remove('show');
        });
        
        document.getElementById('cancel-edit-entry-btn').addEventListener('click', () => {
            document.getElementById('edit-entry-modal').classList.remove('show');
        });
        
        // Close Modals
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('add-moment-modal').classList.remove('show');
        });
        
        document.getElementById('cancel-btn').addEventListener('click', () => {
            document.getElementById('add-moment-modal').classList.remove('show');
        });
        
        // Lightbox Close
        document.getElementById('lightbox-close').addEventListener('click', () => {
            document.getElementById('lightbox').classList.remove('show');
        });
        
        document.getElementById('lightbox').addEventListener('click', (e) => {
            if (e.target.id === 'lightbox') {
                document.getElementById('lightbox').classList.remove('show');
            }
        });
        
        // Initialize
        loadData();
    </script>
</body>
</html>
